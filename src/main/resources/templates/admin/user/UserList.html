<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Administrator</title>
	<link rel="stylesheet" th:href="@{/css/style_admin.css}">
</head>
<body>
<div id="wrap">
	<th:block th:include="/admin/Admin_header"/>
	<main>
		<th:block th:include="/admin/Admin_aside"/>
		<section class="userlist">
			<section>
				<h3>회원목록</h3>
				<article>
					<table>
						<thead>
						<tr>
							<th><input type="checkbox" name="selectall" onclick="selectAll(this)"></th>
							<th>아이디</th>
							<th>이름</th>
							<th>별명</th>
							<th>이메일</th>
							<th>휴대폰</th>
							<th>등급</th>
							<th>가입일</th>
							<th>확인</th>
						</tr>
						</thead>
						<tbody>
						<tr th:if="${userDto == null}">
							<td colspan="10" style="width: 100%;">등록된 회원이 없습니다.</td>
						</tr>
						<tr var="user" th:each="user:${userDto}">
							<td><input type="checkbox" name="select"></td>
							<td th:text="${user.userUid}"></td>
							<td th:text="${user.userName}"></td>
							<td th:text="${user.userNick}"></td>
							<td th:text="${user.userEmail}"></td>
							<td th:text="${user.userHp}"></td>
							<td>

								<select class="usergrade" th:data-id="${user.userUid}">
									<option value="ADMIN" th:selected="${user.userRole}=='ADMIN'">1</option>
									<option value="2" th:selected="${user.userRole}==2">2</option>
									<option value="3" th:selected="${user.userRole}==3">3</option>
									<option value="4" th:selected="${user.userRole}==4">4</option>
									<option value="5" th:selected="${user.userRole}==5">5</option>
									<option value="0" th:selected="${user.userRole}==0">0</option>
								</select>
							</td>
							<td th:text="${user.userRegDate}"></td>
							<td><a href="#">[상세확인]</a></td>
							</tr>
						</tbody>
					</table>
				</article>
<!--				<article class="paging">-->
<!--					<p>-->
<!--						<c:if test="${PageGroup.start > 1}">-->
<!--							<a href="?page=${PageGroup.start-1}"> &lt; </a>-->
<!--						</c:if>-->
<!--						<c:forEach var="i" begin="${PageGroup.start}" end="${PageGroup.end}">-->
<!--							<c:if test="${i<=LastPage}">-->
<!--								<a href="?page=${i}" class="num ${i eq Current?'current':'off'}">[${i}]</a>-->
<!--							</c:if>-->
<!--						</c:forEach>-->
<!--						<c:if test="${PageGroup.end < LastPage}">-->
<!--							<a href="?page=${PageGroup.end+1}"> &gt; </a>-->
<!--						</c:if>-->

<!--					</p>-->
<!--				</article>-->
			</section>
		</section>
	</main>
</div>
<th:block th:include="/admin/Admin_footer"/>
</body>
<script>
	const now = document.querySelector('a#userlist[href]');
	if (now) {
		now.classList.add("now");
	}

	function checkSelectAll(checkbox)  {
		const selectall = document.querySelector('input[name="selectall"]');

		if(checkbox.checked === false)  {
			selectall.checked = false;
		}
	}

	function selectAll(selectAll)  {
		const checkboxes = document.getElementsByName('select');

		checkboxes.forEach((checkbox) => {
			checkbox.checked = selectAll.checked
		})
	}

	function updateUserGrade(id, grade) {
		console.log(`User ID: ${id}`);  // 디버깅 로그
		console.log(`New Grade: ${grade}`);  // 디버깅 로그

		const data = {
			userUid: id,
			userRole: grade
		};


		fetch('/admin/UserList/Update', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(data)
		})
				.then(resp=>resp.json())
				.then(data=>{
					console.log(data);
					if (data.result != 0) {
						alert('정보가 성공적으로 수정되었습니다.');
					} else {
						alert('정보 수정에 실패했습니다.');
					}
				})
				.catch(err => {
					console.error(err);
					alert('업데이트에 실패했습니다.');
				});
	}
	document.addEventListener('DOMContentLoaded', function() {
		// 모든 select 요소에 대해 이벤트 리스너 등록
		document.querySelectorAll('.usergrade').forEach(selectElement => {
			selectElement.addEventListener('input', async function() {
				const id = this.dataset.id;  // data-user-id에서 값 가져오기
				const grade = this.value;

				console.log(`User ID: ${id}`);  // 디버깅 로그
				console.log(`New Grade: ${grade}`);  // 디버깅 로그
				// 사용자 등급 업데이트
				if(confirm('정말 변경하시겠습니까?')){
					updateUserGrade(id, grade);
				}else{
					return;
				}
			});
		});
	});
</script>
</html>